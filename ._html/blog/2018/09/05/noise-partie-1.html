




<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<title>NOISE - Partie 1 - La polyphonie. — Laitues</title>
		<link rel="stylesheet" type="text/css" href="../../../../assets/style.css">
	</head>
	<body>
		<header style="background-image: url('../../../../media/img/2018/09/05-ardour-mixer.png')">
			<h1><a href="../../../../index.html" id="top">Laitues</a></h1>
			<div id="subtitle"><p>Le blog qui ne raconte pas que des salades</p>
</div>
		</header>
		<nav>
			<div class="flowing-menu"><ul>
<li><a href="./../../../../index.html">Laitues &gt;</a>

<ul>
<li><a href="./../../../../blog/index.html">Blog &gt;</a>

<ul>
<li><a href="./../../../../blog/2018/index.html">2018 &gt;</a>

<ul>
<li><a href="./../../../../blog/2018/09/index.html">09/Septembre &gt;</a>

<ul>
<li><a href="./../../../../blog/2018/09/05/index.html">05 &gt;</a>

<ul>
<li><a href="./../../../../blog/2018/09/05/noise-partie-1.html">NOISE - Partie 1 - La polyphonie.</a></li>
</ul></li>
</ul></li>
<li><a href="./../../../../blog/2018/08/index.html">08/Août &gt;</a>

<ul>
<li><a href="./../../../../blog/2018/08/23/index.html">23 &gt;</a>

<ul>
<li><a href="./../../../../blog/2018/08/23/la-programmation-est-elle-un-art.html">La programmation est-elle un art ?</a></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
<li><a href="./../../../../idees.html">Idées</a></li>
<li><a href="./../../../../apropos.html">À propos</a></li>
</ul></li>
</ul>
</div>
			<ul>
				<li><a  href="../../../../index.html">Laitues</a></li>
				
					
				
					
						<li><a  href="../../../../idees.html">Idées</a></li>
					
				
					
						<li><a  href="../../../../apropos.html">À propos</a></li>
					
				
				
				
					
						<li><a  href="../../../../blog/index.html">Blog</a></li>
					
				
					
				
			</ul>
		</nav>
		<main>
			<aside>
				<h2>Page</h2>
				<p>
					<a href="../../../../index.html">Laitues</a> &gt; <a href="../../../../blog/index.html">Blog</a> &gt; <a href="../../../../blog/2018/index.html">2018</a> &gt; <a href="../../../../blog/2018/09/index.html">09/Septembre</a> &gt; <a href="../../../../blog/2018/09/05/index.html">05</a> &gt; <a href="../../../../blog/2018/09/05/noise-partie-1.html">NOISE - Partie 1 - La polyphonie.</a>
				</p>
				<address><a href="mailto:johynpapin@protonmail.com">Johyn Papin</a></address>
				<time>2018-09-05</time>
				<ul class="tags">
				
					<li><a href="../../../../tag/programmation/index.html">programmation</a></li>
				
					<li><a href="../../../../tag/art/index.html">art</a></li>
				
					<li><a href="../../../../tag/noise/index.html">noise</a></li>
				
					<li><a href="../../../../tag/musique/index.html">musique</a></li>
				
					<li><a href="../../../../tag/noise/index.html">noise</a></li>
				
					<li><a href="../../../../tag/daw/index.html">daw</a></li>
				
					<li><a href="../../../../tag/dsp/index.html">dsp</a></li>
				
				</ul>

				<hr>
				<h2>Tous les tags</h2>
				<ul class="tags">
				
				
				
					<li><a href="../../../../tag/art/index.html">art (2)</a></li>
				
					<li><a href="../../../../tag/blog/index.html">blog (3)</a></li>
				
					<li><a href="../../../../tag/daw/index.html">daw (1)</a></li>
				
					<li><a href="../../../../tag/dsp/index.html">dsp (1)</a></li>
				
					<li><a href="../../../../tag/musique/index.html">musique (1)</a></li>
				
					<li><a href="../../../../tag/noise/index.html">noise (1)</a></li>
				
					<li><a href="../../../../tag/programmation/index.html">programmation (2)</a></li>
				
				</ul>

				<hr>
				<h2>Pages récentes</h2>
				<ul>
					
					<li><a href="../../../../blog/2018/09/05/noise-partie-1.html">NOISE - Partie 1 - La polyphonie.</a> (2018-09-05)</li>
					
					<li><a href="../../../../blog/2018/08/23/la-programmation-est-elle-un-art.html">La programmation est-elle un art ?</a> (2018-08-23)</li>
					
					<li><a href="../../../../idees.html">Idées</a> (2018-05-31)</li>
					
					<li><a href="../../../../index.html">Le blog qui ne raconte pas que des salades</a> (2018-05-24)</li>
					
					<li><a href="../../../../apropos.html">À propos</a> (2018-05-20)</li>
				
				</ul>
				
				<hr>
				<h2>À propos</h2>
				<p>Bienvenue sur le site web des laitues ! Nous sommes un groupe formé de <em>Johyn Papin</em> et <em>Quentin Ribac</em>, étudiants français en informatique. Ce site est hébergé dans <a href="https://github.com/lesLaitues/lesLaitues.github.io">ce dépôt GitHub</a>.</p>

				<hr>
				<h2>Langues disponibles</h2>
				<ul>
				
				
					
				
					
						<li><a href="../../../../blog/2018/09/05/noise-partie-1.html"><img src="../../../../media/img/flag_fr.png" alt="flag_fr">&nbsp;Français</a></li>
					
				
				</ul>
			</aside>
			<section>
<h1>NOISE - Partie 1 - La polyphonie.</h1>

<p>Bonjour lectrice, lecteur. Dans ce premier article d’une série qui je l’espère sera intéressante je vais vous présenter <strong>NOISE</strong> et quelques choix que j’ai dû effectuer.</p>

<hr>

<p>J’aime la musique. J’aime aussi programmer. Mais jouer de la musique et programmer, ça prends du temps. Beaucoup de temps. Alors que faire ?
La solution que j’ai trouvé, c’est de faire les deux en même temps. J’ai donc décidé de faire de la musique électronique en programmant moi-même tout ce dont j’ai besoin. C’est ça, <strong>NOISE</strong> (<strong>N</strong>oise <strong>O</strong>rchestrator <strong>I</strong>s <strong>S</strong>uper <strong>E</strong>njoyable).</p>

<blockquote>
<p>Tous les grands projets commencent comme ça : <code>&gt; nvim</code></p>

<p>Et comme nom : NOISE (Noise Orchestrator Is Super Enjoyable)</p>
</blockquote>

<p>C’est un projet très intéressant pour moi pour plusieurs raisons :</p>

<ul>
<li>Améliorer mes compétences en programmation</li>
<li>Apprendre le DSP (Digital Signal Processing), c’est-à-dire comment traiter des signaux (ici, de l’audio)</li>
<li>Apprendre le fonctionnement des synthétiseurs et des logiciels audios en général</li>
<li>Découvrir la programmation en temps réel (on va le voir, il faut être rapide)</li>
</ul>

<p>Je me rend compte maintenant que c’est probablement le projet le plus ambitieux que je n’ai jamais commencé. En effet, très vite les problèmes ont commencés à apparaître. J’ai dû me rendre à l’évidence : ça n’allait pas être facile. Pas du tout.</p>

<p>Dans cet article je vais présenter l’un deux : la polyphonie.</p>

<h2>L’apparition du problème</h2>

<p>Quand j’ai commencé a développer, je me suis inspiré des synthétiseurs modulaires. L’idée était de pouvoir créer des instruments en reliant des modules (générateur, filtre…). Ensuite, je voulais pouvoir créer des boucles en jouant sur mon clavier maître.</p>

<p><img src="./../../../../media/img/2018/09/05-noise-synthe-modulaire.png" alt="Un exemple de « patch » sur une ancienne version de NOISE." /></p>

<p>Ça fonctionnait bien. J’étais très content de moi : j’avançais vite.</p>

<p>C’est alors que je décide d’ajouter le support des périphériques MIDI (<strong>M</strong>usical <strong>I</strong>nstrument <strong>D</strong>igital <strong>I</strong>nterface) pour pouvoir jouer des sons avec mon super clavier maître.</p>

<p>J’ai donc programmé ça en utilisant les librairies <a href="https://github.com/gomidi/midi/">github.com/gomidi/midi</a> et <a href="https://github.com/rakyll/portmidi">github.com/rakyll/portmidi</a> (la première librairie a été mise à jour et est devenue beaucoup plus simple à utiliser depuis).</p>

<p>Pour faire le lien avec le « patch » (c’est-à-dire une des configurations du synthétiseur modulaire), j’ai rajouté un module « d’entrée » qui fait passer la fréquence de la note a jouer à l’instrument (le patch). Ainsi, quand j’appuyais sur une touche du clavier maître le signal MIDI était transformé en fréquence puis envoyé par ce module « d’entrée » à un patch (instrument si vous préferez : une configuration possible d’un synthétiseur modulaire). Ce patch traitait alors la fréquence puis produisait un signal audio. Quand la note s’arrêtait, le son était coupé.</p>

<p>Je ne m’en étais pas encore rendu compte, mais je venais de réaliser une erreur fondamentale : un synthétiseur modulaire n’a pas besoin de notes pour faire du son, c’est tout le principe. Il <strong>peut</strong> en utiliser, mais il ne doit pas en avoir besoin. Or, avec ce que je venais de faire, le synthétiseur ne pouvait plus produire de son si aucune note n’était envoyée au module « d’entrée ».</p>

<p>Ignorant cela, je commence a jouer mais… Malheur. Je ne peux jouer qu’une note à la fois ! Mince… Peut-être qu’il existe une formule simple pour calculer une « fréquence moyenne » entre n notes ? Bien sûr que non.</p>

<p>La polyphonie, c’est ça : pouvoir jouer plusieurs notes en même temps.</p>

<h2>Zut</h2>

<p>Ce problème n’est pas seulement valable pour les notes au sein d’un même instrument (patch), mais aussi pour mixer plusieurs instruments entre eux. Pour bien expliquer le problème, je dois expliquer comment le son est produit puis envoyé aux haut-parleurs dans <strong>NOISE</strong>.</p>

<p>La librairie qui est au cœur du système est <a href="http://portaudio.com">PortAudio</a> et ses bindings pour le langage Go <a href="https://github.com/gordonklaus/portaudio">github.com/gordonklaus/portaudio</a>.
Cette librairie permet de créer des programmes qui vont être capable d’accéder aux interfaces audio sur des tas de plateformes différentes (LINUX, Windows…).
Le principe est simple : il faut écrire un callback, c’est-à-dire une fonction qui va être passée en paramètre à <code>PortAudio</code>. Cette fonction va être ensuite appelée quand il faudra que <strong>NOISE</strong> produise du son. C’est là que ça commence à se corser : il faut être rapide. Si jamais on ne calcule pas les signaux audio suffisamment rapidement, <code>PortAudio</code> va être obligé d’envoyer des données aléatoires aux haut-parleurs. Concrètement, ça va s’entendre pas des claquements dans le signal audio.
Ça signifie qu’il faut limiter les appels systèmes (déclaration de variables, utilisation de verrous…).</p>

<p>Voici le callback de <strong>NOISE</strong> au moment où j’écris ces lignes :</p>

<pre><code class="language-go">func (p *Player) processAudio(out [][]float32) {
    if p.Processor == nil {
        return
    }

    frame := p.Processor.ProcessFrame(len(out[0]))
    var tmp float32

    for i := range out[0] {
        tmp = float32(frame[i])
        out[0][i] = tmp
        out[1][i] = tmp
    }
}
</code></pre>

<p>Concrètement, la fonction prends en paramètre un buffer qui contient des données aléatoires et doit les remplacer par un signal audio. Ces signaux sont en fait des nombres réels (0,42 par exemple) qui doivent être compris entre -1 et 1. Si on dépasse ces valeurs, on va parler d’overload : on va entendre des claquements.</p>

<p>Voici maintenant le problème :</p>

<p>Prenons deux signaux simples (des sinusoïdes) qui varient donc entre -1 et 1. Comment faire pour jouer les deux en même temps ?</p>

<p>Bêtement, on peut tenter de les additionner. Malheureusement non, ce serait trop beau. On risque d’arriver a des valeurs plus grandes que 1 ou plus petites que -1. Une solution est alors de diviser le résultat par 2.</p>

<p>Cette solution fonctionne, mais elle réduit d’autant le volume de chaque signal. Au début, c’est la solution que j’avais adopté. Mais, quand je jouais deux notes j’entendais immédiatement le volume diminuer. Ce n’est pas envisageable en vrai.</p>

<p>J’ai commencé a fouiller dans les forums, à regarder dans le code des autres logiciels. Mais je ne trouvais rien d’évident. La seule piste que j’avais, c’est que certains logiciels limitaient la polyphonie à un nombre arbitraire (par exemple 24).</p>

<p>J’ai compris que ces logiciels divisaient en fait les signaux par ce même nombre, peu importe le nombre de notes. Ainsi, tant que plus de 24 signaux ne sont pas joués, impossible de dépasser les bornes (-1 et 1). Le truc c’est que ça fait un son vraiment faible, et que ça me semblait moche.</p>

<h2>La solution \o/</h2>

<p>C’est il y a peu que j’ai finalement trouvé la solution :</p>

<p><strong>Il n’y en pas !</strong></p>

<blockquote>
<p>Fichtre ! Pourquoi je viens de lire tout ça alors ?!</p>
</blockquote>

<p>Pas de panique. Il faut en fait <strong>laisser l’utilisateur s’en occuper</strong>. C’est à ça que servent les <strong>mixeurs</strong>.</p>

<p><img src="./../../../../media/img/2018/09/05-ardour-mixer.png" alt="Le mixeur du logiciel libre et open-source **Ardour**." /></p>

<p>Cette interface que l’on retrouve dans la plupart des logiciels permet en fait de surveiller que l’overload dont nous parlions n’arrive pas. De plus, il permet d’ajuster le volume des instruments pour éviter qu’ils ne soient trop faibles.</p>

<h2>Conclusion</h2>

<p>Je tiens à rappeler que je ne suis pas du tout un ingénieur DSP. Je n’y connais rien du tout. Du peu que j’en ai vu, c’est un domaine vaste et passionnant, mais aussi et surtout très complexe. Peut-être que la solution que je propose dans cet article n’est pas du tout la bonne, et que je suis passé a côté de quelque chose. Si je trouve autre chose, j’en parlerais dans un prochain article. :-D</p>

<h2>Sources</h2>

<ul>
<li><a href="https://ardour.org/">Ardour</a></li>
<li><a href="http://portaudio.com/">PortAudio</a></li>
</ul>



			</section>
		</main>
		<footer>
			
				<address><a href="mailto:johynpapin@protonmail.com">Johyn Papin</a></address>
			
				<address><a href="mailto:ribac.quentin@gmail.com">Quentin Ribac</a></address>
			
			<p>Le contenu de ce site est placé sous licence <a href="https://creativecommons.org/publicdomain/zero/1.0">CC0</a>.</p>

			<p>
				<a href="https://github.com/ribacq/tomato">Généré statiquement avec Tomato</a>
			</p>
			<p>
				<a href="#top">Retour en haut de page</a>
			</p>
		</footer>
		<!-- load JS -->
		<script type="text/javascript" src="../../../../assets/main.js"><p>Désolé, vous ne semblez pas avoir activé JavaScript.</p></script>
	</body>
</html>
